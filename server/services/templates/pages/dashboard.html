{{define "content"}}
<div class="dashboard-section bg-light min-vh-100">
  <!-- Navigation Header -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm border-bottom">
    <div class="container-fluid px-4">
      <!-- Brand -->
      <a class="navbar-brand d-flex align-items-center" href="/">
        <i class="fas fa-link text-primary me-2" style="font-size: 1.5rem"></i>
        <span class="fw-bold text-primary">Parallax</span>
      </a>

      <!-- User Menu -->
      <div class="dropdown">
        <button
          class="btn btn-outline-primary rounded-pill d-flex align-items-center"
          type="button"
          data-bs-toggle="dropdown"
        >
          <i class="fas fa-user-circle me-2"></i>
          <span class="d-none d-sm-inline">{{.Data.Username}}</span>
          <i class="fas fa-chevron-down ms-2 small"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="/account">
              <i class="fas fa-user-cog me-2"></i>Account
            </a>
          </li>
          <li>
            <a
              class="dropdown-item"
              href="#"
              onclick="alert('Support coming soon!'); return false;"
            >
              <i class="fab fa-discord me-2"></i>Support
            </a>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <form method="POST" action="/api/auth/logout" class="m-0">
              <button
                type="submit"
                class="dropdown-item text-danger border-0 bg-transparent w-100 text-start"
              >
                <i class="fas fa-sign-out-alt me-2"></i>Sign Out
              </button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid px-4 py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="welcome-card bg-gradient-primary text-white rounded-4 p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="fw-bold mb-2">Welcome back, {{.Data.Username}}! ðŸ‘‹</h2>
              <p class="mb-3 opacity-90">
                Here is what is happening with your links today.
              </p>
              <button
                class="btn btn-light btn-lg rounded-pill px-4"
                onclick="openCreateModal()"
              >
                <i class="fas fa-plus me-2"></i>Create New Link
              </button>
            </div>
            <div class="col-md-4 text-center d-none d-md-block">
              <i
                class="fas fa-chart-line"
                style="font-size: 4rem; opacity: 0.3"
              ></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card bg-white rounded-4 p-4 h-100 shadow-sm border">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div
                class="stat-icon bg-primary bg-opacity-10 text-primary rounded-3 p-3 mb-3"
              >
                <i class="fas fa-link fa-lg"></i>
              </div>
              <h3 class="fw-bold mb-1">{{.Data.Pagination.TotalItems}}</h3>
              <p class="text-muted mb-0 small">Total Links</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card bg-white rounded-4 p-4 h-100 shadow-sm border">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div
                class="stat-icon bg-success bg-opacity-10 text-success rounded-3 p-3 mb-3"
              >
                <i class="fas fa-mouse-pointer fa-lg"></i>
              </div>
              <h3 class="fw-bold mb-1">{{.Data.Stats.TotalClicks}}</h3>
              <p class="text-muted mb-0 small">Total Clicks</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card bg-white rounded-4 p-4 h-100 shadow-sm border">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div
                class="stat-icon bg-warning bg-opacity-10 text-warning rounded-3 p-3 mb-3"
              >
                <i class="fas fa-chart-bar fa-lg"></i>
              </div>
              <h3 class="fw-bold mb-1">
                {{printf "%.1f" .Data.Stats.AvgClicksPerDay}}
              </h3>
              <p class="text-muted mb-0 small">Avg. Clicks/Day (7d)</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card bg-white rounded-4 p-4 h-100 shadow-sm border">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div
                class="stat-icon bg-danger bg-opacity-10 text-danger rounded-3 p-3 mb-3"
              >
                <i class="fas fa-exclamation-triangle fa-lg"></i>
              </div>
              <h3 class="fw-bold mb-1">{{.Data.Stats.UnhealthyLinks}}</h3>
              <p class="text-muted mb-0 small">Unhealthy Links</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Links Table Section -->
    <div class="row">
      <div class="col-12">
        <div class="card-modern bg-white rounded-4 shadow-sm border">
          <div class="card-header bg-transparent border-0 p-4 pb-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-bold mb-0">My Links</h5>
            </div>

            <!-- Search and Filters -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text bg-light border-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-0 bg-light"
                    id="searchInput"
                    placeholder="Search links by URL, code, slug, or description..."
                  />
                </div>
              </div>
              <div
                class="col-md-6 d-flex justify-content-end align-items-center"
              >
                <button
                  class="btn btn-primary rounded-pill px-4"
                  onclick="performSearch()"
                >
                  <i class="fas fa-search me-2"></i>Search
                </button>
              </div>
            </div>

            <!-- Pagination Controls -->
            <div class="row g-3 align-items-center">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-0 me-2"
                  >Page Size:</label
                >
                <select
                  class="form-select form-select-sm d-inline-block w-auto"
                  id="pageSizeSelect"
                  onchange="changePageSize()"
                >
                  <option
                    value="5"
                    {{if
                    eq
                    .Data.Pagination.PageSize
                    5}}selected{{end}}
                  >
                    5
                  </option>
                  <option
                    value="10"
                    {{if
                    eq
                    .Data.Pagination.PageSize
                    10}}selected{{end}}
                  >
                    10
                  </option>
                  <option
                    value="25"
                    {{if
                    eq
                    .Data.Pagination.PageSize
                    25}}selected{{end}}
                  >
                    25
                  </option>
                  <option
                    value="50"
                    {{if
                    eq
                    .Data.Pagination.PageSize
                    50}}selected{{end}}
                  >
                    50
                  </option>
                  <option
                    value="100"
                    {{if
                    eq
                    .Data.Pagination.PageSize
                    100}}selected{{end}}
                  >
                    100
                  </option>
                </select>
              </div>
              <div class="col-md-8 text-end">
                <span class="text-muted small me-3">
                  Page {{.Data.Pagination.CurrentPage}} of
                  {{.Data.Pagination.TotalPages}}
                  ({{.Data.Pagination.TotalItems}} total)
                </span>
                <button
                  class="btn btn-sm btn-outline-secondary rounded-pill"
                  {{if
                  eq
                  .Data.Pagination.CurrentPage
                  1}}disabled{{end}}
                  onclick="changePage({{add .Data.Pagination.CurrentPage -1}})"
                >
                  <i class="fas fa-chevron-left"></i> Prev
                </button>
                <button
                  class="btn btn-sm btn-outline-secondary rounded-pill ms-2"
                  {{if
                  eq
                  .Data.Pagination.CurrentPage
                  .Data.Pagination.TotalPages}}disabled{{end}}
                  onclick="changePage({{add .Data.Pagination.CurrentPage 1}})"
                >
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="card-body p-4">
            {{if .Data.Links}}
            <!-- Links Table -->
            <div class="table-responsive" id="linksTableContainer">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Short Code</th>
                    <th>Description</th>
                    <th>Custom Slug</th>
                    <th class="text-center">Clicks</th>
                    <th>Last Clicked</th>
                    <th>Created</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{range .Data.Links}}
                  <tr>
                    <td>
                      <code class="text-primary">{{.ShortCode}}</code>
                    </td>
                    <td>
                      {{if .Description}}
                      <span
                        class="text-truncate d-inline-block"
                        style="max-width: 200px"
                        title="{{.Description}}"
                      >
                        {{.Description}}
                      </span>
                      {{else}}
                      <span class="text-muted fst-italic">No description</span>
                      {{end}}
                    </td>
                    <td>
                      {{if .CustomSlug}}
                      <span class="badge bg-secondary">{{.CustomSlug}}</span>
                      {{else}}
                      <span class="text-muted">â€”</span>
                      {{end}}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary rounded-pill"
                        >{{.ClickCount}}</span
                      >
                    </td>
                    <td>
                      {{if .LastClickedAt}}
                      <small>{{formatDate .LastClickedAt}}</small>
                      {{else}}
                      <span class="text-muted">Never</span>
                      {{end}}
                    </td>
                    <td>
                      <small>{{formatDate .CreatedAt}}</small>
                    </td>
                    <td class="text-center">
                      {{if eq .HealthStatus "HEALTHY"}}
                      <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>Healthy
                      </span>
                      {{else}}
                      <span class="badge bg-danger">
                        <i class="fas fa-times-circle me-1"></i>Unhealthy
                      </span>
                      {{end}}
                    </td>
                    <td class="text-center">
                      <div class="dropdown">
                        <button
                          class="btn btn-sm btn-outline-secondary rounded-pill"
                          data-bs-toggle="dropdown"
                        >
                          <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li>
                            <a
                              class="dropdown-item"
                              href="#"
                              onclick="copyToClipboard('{{.ShortURL}}'); return false;"
                            >
                              <i class="fas fa-copy me-2"></i>Copy Link
                            </a>
                          </li>
                          <li>
                            <a
                              class="dropdown-item"
                              href="#"
                              onclick="openEditModal({{.ID}}, '{{.OriginalURL}}', '{{if .CustomSlug}}{{.CustomSlug}}{{end}}', '{{.ShortCode}}', '{{if .Description}}{{.Description}}{{end}}'); return false;"
                            >
                              <i class="fas fa-edit me-2"></i>Edit
                            </a>
                          </li>
                          <li><hr class="dropdown-divider" /></li>
                          <li>
                            <a
                              class="dropdown-item text-warning"
                              href="#"
                              onclick="archiveLink({{.ID}}); return false;"
                            >
                              <i class="fas fa-archive me-2"></i>Archive
                            </a>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
            {{else}}
            <!-- Empty State -->
            <div class="text-center py-5">
              <i
                class="fas fa-link text-muted mb-3"
                style="font-size: 4rem; opacity: 0.3"
              ></i>
              <h5 class="text-muted mb-3">No links yet!</h5>
              <p class="text-muted mb-4">
                Create your first link to get started
              </p>
              <button
                class="btn btn-primary rounded-pill px-4"
                onclick="openCreateModal()"
              >
                <i class="fas fa-plus me-2"></i>Create Your First Link
              </button>
            </div>
            {{end}}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Link Modal -->
<div class="modal fade" id="createLinkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-plus-circle text-primary me-2"></i>Create New Link
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="createLinkForm">
          <div class="mb-3">
            <label for="createOriginalUrl" class="form-label fw-medium"
              >Original URL <span class="text-danger">*</span></label
            >
            <input
              type="url"
              class="form-control"
              id="createOriginalUrl"
              placeholder="https://example.com/your-long-url"
              required
            />
          </div>
          <div class="mb-3">
            <label for="createDescription" class="form-label fw-medium"
              >Description</label
            >
            <input
              type="text"
              class="form-control"
              id="createDescription"
              placeholder="Optional description"
            />
          </div>
          <div class="mb-3">
            <label for="createCustomSlug" class="form-label fw-medium"
              >Custom Slug</label
            >
            <input
              type="text"
              class="form-control"
              id="createCustomSlug"
              placeholder="my-custom-slug"
            />
          </div>
          <div id="createErrorMessage" class="alert alert-danger d-none"></div>
          <div
            id="createSuccessMessage"
            class="alert alert-success d-none"
          ></div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-secondary rounded-pill"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary rounded-pill"
          onclick="submitCreateLink()"
          id="createSubmitBtn"
        >
          <span id="createBtnText"
            ><i class="fas fa-plus me-2"></i>Create Link</span
          >
          <span id="createBtnLoading" class="d-none"
            ><span class="spinner-border spinner-border-sm me-2"></span
            >Creating...</span
          >
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Link Modal -->
<div class="modal fade" id="editLinkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-edit text-primary me-2"></i>Edit Link
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editLinkForm">
          <input type="hidden" id="editLinkId" />
          <input type="hidden" id="editShortUrl" />
          <div class="mb-3">
            <label for="editShortCode" class="form-label fw-medium"
              >Short Code</label
            >
            <input
              type="text"
              class="form-control"
              id="editShortCode"
              disabled
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label fw-medium">Short Link</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control bg-light"
                id="editDisplayUrl"
                readonly
              />
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="copyLinkFromModal()"
              >
                <i class="fas fa-copy me-1"></i>Copy
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label for="editOriginalUrl" class="form-label fw-medium"
              >Original URL <span class="text-danger">*</span></label
            >
            <input
              type="url"
              class="form-control"
              id="editOriginalUrl"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label fw-medium"
              >Description</label
            >
            <input type="text" class="form-control" id="editDescription" />
          </div>
          <div class="mb-3">
            <label for="editCustomSlug" class="form-label fw-medium"
              >Custom Slug</label
            >
            <input type="text" class="form-control" id="editCustomSlug" />
          </div>
          <div id="editErrorMessage" class="alert alert-danger d-none"></div>
          <div id="editSuccessMessage" class="alert alert-success d-none"></div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-secondary rounded-pill"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary rounded-pill"
          onclick="submitEditLink()"
          id="editSubmitBtn"
        >
          <span id="editBtnText"
            ><i class="fas fa-save me-2"></i>Save Changes</span
          >
          <span id="editBtnLoading" class="d-none"
            ><span class="spinner-border spinner-border-sm me-2"></span
            >Saving...</span
          >
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .dashboard-section {
    font-family: "Roboto", sans-serif;
  }
  .welcome-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border: none;
  }
  .stat-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
  }
  .stat-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .table tbody tr {
    transition: background-color 0.2s ease;
  }
  .table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
  }
  .table-responsive {
    overflow: visible !important;
    max-height: none !important;
  }
  .card-body.p-4 {
    overflow: visible !important;
  }
  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }
    .table {
      font-size: 0.875rem;
    }
  }
</style>

<script>
  let currentPage = {{.Data.Pagination.CurrentPage}};
  let currentPageSize = {{.Data.Pagination.PageSize}};
  let currentSearch = '';
  let createModal, editModal;

  document.addEventListener('DOMContentLoaded', function() {
    createModal = new bootstrap.Modal(document.getElementById('createLinkModal'));
    editModal = new bootstrap.Modal(document.getElementById('editLinkModal'));
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performSearch();
    });
  });

  function openCreateModal() {
    document.getElementById('createLinkForm').reset();
    document.getElementById('createErrorMessage').classList.add('d-none');
    document.getElementById('createSuccessMessage').classList.add('d-none');
    createModal.show();
  }

  function openEditModal(id, originalUrl, customSlug, shortCode, description, shortUrl) {
    document.getElementById('editLinkId').value = id;
    document.getElementById('editShortCode').value = shortCode;
    document.getElementById('editOriginalUrl').value = originalUrl;
    document.getElementById('editCustomSlug').value = customSlug || '';
    document.getElementById('editDescription').value = description || '';
    document.getElementById('editShortUrl').value = shortUrl;
    document.getElementById('editDisplayUrl').value = shortUrl;
    document.getElementById('editErrorMessage').classList.add('d-none');
    document.getElementById('editSuccessMessage').classList.add('d-none');
    editModal.show();
  }

  function copyLinkFromModal() {
    const shortUrl = document.getElementById('editShortUrl').value;
    if (shortUrl) {
      navigator.clipboard.writeText(shortUrl).then(() => {
        // Change button text temporarily
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-primary');
        }, 2000);
      }).catch(() => {
        alert('Failed to copy link');
      });
    }
  }

  async function submitCreateLink() {
    const originalUrl = document.getElementById('createOriginalUrl').value.trim();
    const description = document.getElementById('createDescription').value.trim();
    const customSlug = document.getElementById('createCustomSlug').value.trim();
    if (!originalUrl) { showError('createErrorMessage', 'Original URL is required'); return; }

    document.getElementById('createBtnText').classList.add('d-none');
    document.getElementById('createBtnLoading').classList.remove('d-none');
    document.getElementById('createSubmitBtn').disabled = true;

    try {
      const response = await fetch('/api/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ original_url: originalUrl, description: description || null, custom_slug: customSlug || null })
      });
      if (response.ok) {
        showSuccess('createSuccessMessage', 'Link created successfully!');
        setTimeout(() => { createModal.hide(); window.location.reload(); }, 1000);
      } else {
        const errorText = await response.text();
        showError('createErrorMessage', errorText || 'Failed to create link');
      }
    } catch (error) {
      showError('createErrorMessage', 'Network error. Please try again.');
    } finally {
      document.getElementById('createBtnText').classList.remove('d-none');
      document.getElementById('createBtnLoading').classList.add('d-none');
      document.getElementById('createSubmitBtn').disabled = false;
    }
  }

  async function submitEditLink() {
    const id = document.getElementById('editLinkId').value;
    const originalUrl = document.getElementById('editOriginalUrl').value.trim();
    const description = document.getElementById('editDescription').value.trim();
    const customSlug = document.getElementById('editCustomSlug').value.trim();
    if (!originalUrl) { showError('editErrorMessage', 'Original URL is required'); return; }

    document.getElementById('editBtnText').classList.add('d-none');
    document.getElementById('editBtnLoading').classList.remove('d-none');
    document.getElementById('editSubmitBtn').disabled = true;

    try {
      const response = await fetch(`/api/links/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ original_url: originalUrl, description: description || null, custom_slug: customSlug || null })
      });
      if (response.ok) {
        showSuccess('editSuccessMessage', 'Link updated successfully!');
        setTimeout(() => { editModal.hide(); window.location.reload(); }, 1000);
      } else {
        const errorText = await response.text();
        showError('editErrorMessage', errorText || 'Failed to update link');
      }
    } catch (error) {
      showError('editErrorMessage', 'Network error. Please try again.');
    } finally {
      document.getElementById('editBtnText').classList.remove('d-none');
      document.getElementById('editBtnLoading').classList.add('d-none');
      document.getElementById('editSubmitBtn').disabled = false;
    }
  }

  async function archiveLink(id) {
    if (!confirm('Are you sure you want to archive this link?')) return;
    try {
      const response = await fetch(`/api/links/${id}/archived`, { method: 'PATCH' });
      if (response.ok) window.location.reload();
      else alert('Failed to archive link');
    } catch (error) {
      alert('Network error. Please try again.');
    }
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('Link copied!')).catch(() => alert('Failed to copy'));
  }

  async function performSearch() {
    currentSearch = document.getElementById('searchInput').value.trim();
    currentPage = 1;
    await reloadTable();
  }

  async function changePage(newPage) {
    currentPage = newPage;
    await reloadTable();
  }

  async function changePageSize() {
    currentPageSize = parseInt(document.getElementById('pageSizeSelect').value);
    currentPage = 1;
    await reloadTable();
  }

  async function reloadTable() {
    try {
      const params = new URLSearchParams({
        page: currentPage,
        page_size: currentPageSize,
        search: currentSearch,
      });

      const response = await fetch(`/api/links/dashboard?${params}`);

      if (response.ok) {
        const data = await response.json();
        updateTableUI(data);
      } else {
        console.error('Failed to reload table');
        alert('Failed to load links. Please refresh the page.');
      }
    } catch (error) {
      console.error('Network error:', error);
      alert('Network error. Please check your connection.');
    }
  }

  function updateTableUI(data) {
    const pagination = data.pagination;
    const links = data.links || [];

    // Update pagination state
    currentPage = pagination.current_page;

    // Update pagination info text
    document.querySelector('.col-md-8.text-end .text-muted').textContent =
      `Page ${pagination.current_page} of ${pagination.total_pages} (${pagination.total_items} total)`;

    // Update pagination buttons
    const prevBtn = document.querySelector('.col-md-8.text-end .btn:first-of-type');
    const nextBtn = document.querySelector('.col-md-8.text-end .btn:last-of-type');

    prevBtn.disabled = pagination.current_page === 1;
    nextBtn.disabled = pagination.current_page === pagination.total_pages || pagination.total_pages === 0;

    // Update total links stat card
    document.querySelector('.stat-card h3').textContent = pagination.total_items;

    // Update table content
    const cardBody = document.querySelector('.card-body.p-4');

    if (links.length === 0) {
      // Show empty state
      cardBody.innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-link text-muted mb-3" style="font-size: 4rem; opacity: 0.3;"></i>
          <h5 class="text-muted mb-3">No links found!</h5>
          <p class="text-muted mb-4">${currentSearch ? 'Try a different search term' : 'Create your first link to get started'}</p>
          <button class="btn btn-primary rounded-pill px-4" onclick="openCreateModal()">
            <i class="fas fa-plus me-2"></i>${currentSearch ? 'Create New Link' : 'Create Your First Link'}
          </button>
        </div>
      `;
    } else {
      // Rebuild table
      let tableHTML = `
        <div class="table-responsive" id="linksTableContainer">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Short Code</th>
                <th>Description</th>
                <th>Custom Slug</th>
                <th class="text-center">Clicks</th>
                <th>Last Clicked</th>
                <th>Created</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      links.forEach(link => {
        const description = link.description
          ? `<span class="text-truncate d-inline-block" style="max-width: 200px;" title="${escapeHtml(link.description)}">${escapeHtml(link.description)}</span>`
          : '<span class="text-muted fst-italic">No description</span>';

        const customSlug = link.custom_slug
          ? `<span class="badge bg-secondary">${escapeHtml(link.custom_slug)}</span>`
          : '<span class="text-muted">â€”</span>';

        const lastClicked = link.last_clicked_at
          ? `<small>${formatDateClient(link.last_clicked_at)}</small>`
          : '<span class="text-muted">Never</span>';

        const status = link.health_status === 'HEALTHY'
          ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Healthy</span>'
          : '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Unhealthy</span>';

        tableHTML += `
          <tr>
            <td><code class="text-primary">${escapeHtml(link.short_code)}</code></td>
            <td>${description}</td>
            <td>${customSlug}</td>
            <td class="text-center"><span class="badge bg-primary rounded-pill">${link.click_count}</span></td>
            <td>${lastClicked}</td>
            <td><small>${formatDateClient(link.created_at)}</small></td>
            <td class="text-center">${status}</td>
            <td class="text-center">
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary rounded-pill" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" onclick="copyToClipboard('${escapeHtml(link.short_url)}'); return false;">
                      <i class="fas fa-copy me-2"></i>Copy Link
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" onclick="openEditModal(${link.id}, '${escapeHtml(link.original_url)}', '${link.custom_slug || ''}', '${escapeHtml(link.short_code)}', '${link.description || ''}', '${escapeHtml(link.short_url)}'); return false;">
                      <i class="fas fa-edit me-2"></i>Edit
                    </a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item text-warning" href="#" onclick="archiveLink(${link.id}); return false;">
                      <i class="fas fa-archive me-2"></i>Archive
                    </a>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        `;
      });

      tableHTML += `
            </tbody>
          </table>
        </div>
      `;

      cardBody.innerHTML = tableHTML;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDateClient(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function showError(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.classList.remove('d-none');
  }

  function showSuccess(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.classList.remove('d-none');
  }
</script>
{{end}}
